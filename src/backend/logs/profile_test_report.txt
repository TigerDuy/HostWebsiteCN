Profile API end-to-end test report
Timestamp: 2025-11-15T

Summary:
- Backend: http://localhost:3001
- Frontend: http://localhost:3000

Steps performed and outputs:

1) REGISTER (performed earlier)
  - Body: username=testuser_cli, email=testuser_cli_20251115@example.com, password=Test1234
  - (Registration output not captured in terminal log here)

2) LOGIN
  - Request: POST /auth/login
  - Response:
{
  "message": "Đăng nhập thành công!",
  "token": "<token-omitted>",
  "username": "testuser_cli",
  "role": "user",
  "userId": 3
}

3) GET /auth/profile/:userId
  - Request: GET /auth/profile/3 with Authorization: Bearer <token>
  - Response:
{
  "id": 3,
  "username": "testuser_cli",
  "email": "testuser_cli_20251115@example.com",
  "role": "user"
}

4) PUT /auth/profile/:userId (update username/email)
  - Request body: { username: 'testuser_cli_new', email: 'testuser_cli_new_20251115@example.com' }
  - Response (after update):
{
  "id": 3,
  "username": "testuser_cli_new",
  "email": "testuser_cli_new_20251115@example.com",
  "role": "user"
}

5) POST /auth/change-password/:userId
  - Request body: { currentPassword: 'Test1234', newPassword: 'NewPass123' }
  - Response: { "message": "✅ Đổi mật khẩu thành công!" }

6) LOGIN with new password
  - Request: POST /auth/login with email=testuser_cli_new_20251115@example.com and password=NewPass123
  - Response: success (token returned), username: testuser_cli_new

7) Forbidden check: GET /auth/profile/1 using testuser token
  - Response: 403 with { "message": "❌ Bạn không có quyền truy cập!" }

Cleanup:
- Script run: backend/scripts/remove_test_user.js
  - Output: "No user found for testuser_cli_20251115@example.com" and "No user found for testuser_cli_new_20251115@example.com" (means test users already not present at cleanup time)

Notes & recommendations:
- I refactored token-checking to use the existing middleware `verifyToken` in `backend/middleware/auth.js` and updated the routes in `backend/routes/auth.js` to use it.
- Because DB schema uses ON DELETE CASCADE for user-related tables, deleting a user will remove their recipes, comments, favorites, and ratings automatically.
- If you want the test user removed immediately in future runs, ensure the script is run while the user exists; currently it reports none found (maybe DB was cleared or IDs changed).

Files changed/added:
- Modified: backend/routes/auth.js (use verifyToken middleware)
- Added: backend/scripts/remove_test_user.js
- Added: backend/logs/profile_test_report.txt (this file)

If you want, next I can:
- Extract `verifyToken` into a small shared middleware file (already present) and replace any other inline checks (done).
- Add an automated Node.js test script to run these steps and assert responses.
- Run DB cleanup to remove any created recipes/comments if you point to specific test user id.

Report generated by: automated test run (assistant)
